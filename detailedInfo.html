<!Doctype html>
<head>
  <style> body { margin: 0; } </style>
  <script src="//unpkg.com/globe.gl"></script>
</head>

<body>
  <div id="globeViz"></div>

  <script type="module">
      import { scaleSequential } from 'https://esm.sh/d3-scale';
      import { interpolateYlOrRd } from 'https://esm.sh/d3-scale-chromatic';

      const apiUrl = "https://services7.arcgis.com/IyvyFk20mB7Wpc95/arcgis/rest/services/Sustainable_Development_Report_2024_(with_indicators)/FeatureServer/0/query?where=1%3D1&outFields=Overall_Score,Name&outSR=4326&f=json";

      // Function to determine color based on score
      function getColor(score) {
          if (score === null) return 'gray'; // Null values = gray
          if (score <= 40) return 'red';
          if (score <= 60) return 'orange';
          if (score <= 80) return 'yellow';
          return 'green'; // 81-100 red again
      }

      Promise.all([
          fetch('ne_110m_admin_0_countries.geojson').then(res => res.json()),
          fetch(apiUrl).then(res => res.json())
      ]).then(([countries, apiData]) => {
          const scoreMap = new Map();
          apiData.features.forEach(f => {
              const countryName = f.attributes.Name;
              const score = f.attributes.Overall_Score;
              scoreMap.set(countryName, score);
          });

          const world = new Globe(document.getElementById('globeViz'))
              .globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg')
              .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
              .lineHoverPrecision(0)
              .polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ'))
              .polygonAltitude(0.01)
              .polygonCapColor(feat => getColor(scoreMap.get(feat.properties.ADMIN) || null))
              .polygonSideColor(() => 'rgba(0, 0, 0, 0)')
              .polygonStrokeColor(() => '#111')
              .polygonLabel(({ properties: d }) => `
                  <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
                  Score: <i>${scoreMap.get(d.ADMIN) ?? 'N/A'}</i>
              `)
              .onPolygonHover(hoverD => world
                  .polygonAltitude(d => d === hoverD ? 0.06 : 0.01)
                  .polygonCapColor(d => d === hoverD ? 'steelblue' : 'transparent')//getColor(scoreMap.get(d.properties.ADMIN) || null))
              )
              .polygonsTransitionDuration(300);
      });
  </script>
</body>
